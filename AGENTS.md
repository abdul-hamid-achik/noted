# AI Agent Guidelines

This document provides guidelines for AI agents (Claude, GPT, Copilot, etc.) working on the noted codebase.

## Project Overview

**noted** is a CLI knowledge base application written in Go. It stores notes in a local SQLite database with support for tagging, search, import/export, and editor integration.

## Technology Stack

| Component | Technology |
|-----------|------------|
| Language | Go 1.21+ |
| CLI Framework | [Cobra](https://github.com/spf13/cobra) |
| Database | SQLite via [modernc.org/sqlite](https://modernc.org/sqlite) (pure Go, no CGO) |
| SQL Code Gen | [sqlc](https://sqlc.dev) |
| Build Tool | [Task](https://taskfile.dev) |

## Project Structure

```
noted/
├── cmd/                    # CLI commands (one file per command)
│   ├── root.go            # Root command, database lifecycle
│   ├── add.go             # Create notes
│   ├── list.go            # List notes
│   ├── show.go            # Display single note
│   ├── edit.go            # Modify notes
│   ├── delete.go          # Remove notes
│   ├── tags.go            # Tag management
│   ├── grep.go            # Search notes
│   ├── export.go          # Export to markdown/JSON
│   ├── import.go          # Import markdown files
│   ├── version.go         # Version info (ldflags injected)
│   ├── editor.go          # Editor integration helper
│   └── cmd_test.go        # Integration tests
├── internal/
│   ├── config/            # XDG-compliant configuration
│   │   └── config.go      # Config loading, paths
│   └── db/                # Database layer
│       ├── schema.sql     # SQLite schema (source of truth)
│       ├── query.sql      # SQL queries for sqlc
│       ├── db.go          # Connection helper
│       └── *.go           # Generated by sqlc (DO NOT EDIT)
├── sql/                   # SQL source files for sqlc
├── main.go                # Entry point
├── Taskfile.yml           # Build automation
├── sqlc.yaml              # sqlc configuration
└── .goreleaser.yml        # Release configuration
```

## Key Conventions

### Database Changes

1. Modify `internal/db/schema.sql` for schema changes
2. Update `internal/db/query.sql` for new queries
3. Run `task generate` to regenerate Go code
4. **Never edit generated files** in `internal/db/` (except `db.go` and `schema.sql`)

### Adding New Commands

1. Create `cmd/<command>.go`
2. Define the cobra command with `Use`, `Short`, `Long`, `RunE`
3. Register in `init()` via `rootCmd.AddCommand()`
4. Access database via the global `database` variable (set in `root.go`)
5. Add tests to `cmd/cmd_test.go`

### Code Style

- Follow [Effective Go](https://go.dev/doc/effective_go)
- Use `gofmt` for formatting
- Run `task lint` before committing
- Keep functions focused and small
- Prefer returning errors over panicking

### Testing

```bash
task test           # Run all tests
go test -v ./...    # Verbose output
go test -v ./cmd -run TestName  # Specific test
```

Tests use a temporary in-memory database. See `cmd/cmd_test.go` for examples.

## Common Tasks

### Add a new CLI flag

```go
// In init() function
myCmd.Flags().StringP("name", "n", "default", "Description")

// In RunE function
value, _ := cmd.Flags().GetString("name")
```

### Add a new database query

1. Add query to `internal/db/query.sql`:
```sql
-- name: GetNotesByDate :many
SELECT * FROM notes WHERE created_at >= ? ORDER BY created_at DESC;
```

2. Run `task generate`

3. Use in code:
```go
notes, err := database.GetNotesByDate(ctx, startDate)
```

### Version Information

Version is injected at build time via ldflags. See `cmd/version.go`:
- `Version` - Git tag or "dev"
- `Commit` - Git commit SHA
- `BuildDate` - Build timestamp

## Build Commands

```bash
task                # Show available tasks
task generate       # Generate sqlc code
task build          # Build binary to bin/
task test           # Run tests
task lint           # Run golangci-lint
task install        # Install to GOPATH/bin
task clean          # Remove build artifacts
task dev -- list    # Build and run with args
```

## Release Process

Releases are automated via GitHub Actions:

1. Tag a version: `git tag -a v0.2.0 -m "Release v0.2.0"`
2. Push the tag: `git push origin v0.2.0`
3. GoReleaser builds binaries and creates GitHub release
4. Homebrew formula is automatically updated

## Guidelines for AI Agents

### Do

- Read existing code before making changes
- Follow the established patterns in the codebase
- Run `task test` and `task lint` after changes
- Update README.md for user-facing changes
- Keep changes minimal and focused
- Use the existing database layer (sqlc-generated code)

### Don't

- Edit generated files in `internal/db/` (except `db.go`, `schema.sql`)
- Add dependencies without clear justification
- Change the database schema without migration consideration
- Remove or rename exported functions without checking usage
- Add CGO dependencies (project uses pure Go SQLite)

### Error Handling

```go
// Preferred: Return errors with context
if err != nil {
    return fmt.Errorf("failed to load note: %w", err)
}

// For user-facing errors, use cobra's error handling
cmd.SilenceUsage = true  // Don't show usage on runtime errors
return fmt.Errorf("note not found: %d", id)
```

### Database Access Pattern

```go
// Database is initialized in root.go PersistentPreRunE
// Access via global 'database' variable in cmd package
func runMyCommand(cmd *cobra.Command, args []string) error {
    ctx := cmd.Context()
    notes, err := database.ListNotes(ctx)
    if err != nil {
        return fmt.Errorf("failed to list notes: %w", err)
    }
    // ...
}
```

## Useful Context

- Notes are stored with title, content, created_at, updated_at
- Tags are stored in a separate table with many-to-many relationship
- Import supports YAML frontmatter in markdown files
- Export supports both markdown and JSON formats
- Editor integration uses $EDITOR environment variable
- Database location follows XDG spec: `~/.local/share/noted/noted.db`
